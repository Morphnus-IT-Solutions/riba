{% extends "riba-admin/base.html" %}
{% load question_tags %}

{% block extra_css %}
<style>
    .form-row input {
        width: 300px;
    }

    fieldset table{
        border: 0px;
    }

    fieldset table td{
        border: 0px;
    }
</style>

{% endblock %}

{% block breadcrumbs %}
    <!-- Breadcrumbs -->
    <div class="breadcrumbs">
        <a href="/admin/">Home</a>&nbsp;&raquo;&nbsp; <a href="/admin/document/">Documents</a>&nbsp;&raquo;&nbsp; {% if id %}{{template.title}}{% else %}Add{% endif %}
    </div>
    <!-- END Breadcrumbs -->
{% endblock %}

{% block content %}
<div id="questionnaire-content" class="w100p">
    <form action="" method="POST" id="questionnaire" name="questionnaire" enctype="multipart/form-data">
        {% document_tabs request "create-questionnaire" id template %}
        <div class="padding10" style="border:#3F4C6C 1px solid;">
        {% if errors %}
            <div>
                {% for error in errors %}
                    {{error}}
                {% endfor %}
            </div>
        {% endif %}
            <div id="questionnaire_container">
               <fieldset class="aligned" style="border:0px">
                    {{questionnaire_formset.management_form}}
                    {% for form in questionnaire_formset.forms %}
                        <div class="form-row table-form">
                            {% if form %}
                                <table >
                                    <tr>
                                        <td>{{form.question.label}}</td>
                                        <td>{{form.question}}
                                        <a href="/question/add/{{random_count}}{{forloop.counter0}}" class="add-another" name="{{form.question.html_name}}~{{random_count}}{{forloop.counter0}}" id="add_id_{{form.question.html_name}}~{{random_count}}{{forloop.counter0}}" onclick="return showAddAnotherPopup(this);">
                                                        <img src="/media/images/icon_addlink.gif" width="10" height="10" alt="Add Another"/>
                                                    </a>
                                        </td>
                                        <td>{{form.sort_order.label}}</td>
                                        <td>{{form.sort_order}}</td>
                                        <td>Delete</td>
                                        <td>{{form.DELETE}}</td>
                                    </tr>
                                    <tr>
                                        <td colspan=4 id="id_question-{{forloop.counter0}}-details" class="question_details"></td>
                                    </tr>       
                                </table>
                            {% endif %}
                        </div>
                    {% endfor %}
                    <div class="form-row">
                        <input class="w100" title='Add Question' type='button' name='add_question' id='add_another_question' value='+ Add Question' />
                        <input class="w100" type="submit" id="proceed" name="proceed" value="Proceed"/>
                    </div>
               </fieldset>
            </div>
        </div>
    </form>
</div>
{% endblock %}

{% block script_footer %}
{{block.super}}
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.5.0/jquery.min.js"></script>
<script type="text/javascript">
    function updateElementIndex(el, prefix, ndx) {
        var id_regex = new RegExp('(' + prefix + '-\\d+-)');
        var replacement = prefix + '-' + ndx + '-';
        if ($(el).attr("for")) $(el).attr("for", $(el).attr("for").replace(id_regex,replacement));
        if (el.id) el.id = el.id.replace(id_regex, replacement);
        if (el.name) el.name = el.name.replace(id_regex, replacement);
    }

    function cloneMore(selector, type) {
        var newElement = $(selector).clone();
        var total = parseInt($('#id_' + type + '-TOTAL_FORMS').val());
        newElement.find(':input').each(function() {
            var name = $(this).attr('name').replace('-' + (total-1) + '-','-' + total + '-');
            var id = 'id_' + name;
            $(this).attr({'name': name, 'id': id}).val('');
        });
        newElement.find('a').each(function() {
            var name = $(this).attr('name').replace('-' + (total-1) + '-','-' + total + '-');
            var id = 'id_' + name;
            $(this).attr({'name': name, 'id': id}).val('');
        });
        newElement.find('label').each(function() {
            var newFor = $(this).attr('for').replace('-' + (total-1) + '-','-' + total + '-');
            $(this).attr('for', newFor);
        });
        newElement.find('td').each(function() {
            var newid = $(this).attr('id').replace('-' + (total-1) + '-','-' + total + '-');
            $(this).attr('id', newid);
            if($(this).attr('class') == 'question_details'){
                $(this).html('');
            }
        });
        total++;
        $('#id_' + type + '-TOTAL_FORMS').val(total);
        $(selector).after(newElement);
    }

    // Event handlers for Field
    $("#add_another_question").click(function() {
        cloneMore('div.table-form:last', 'questionnaire_set');
    });
$(document).ready(function() {
    $('.check_tabs').click(function(){
        var next_tab = $(this).attr('id');
        new_url = "/admin/document/" + next_tab;
        var id = {{id}};
        if(id) new_url += '/'+id+'/';
        location.href =  new_url;
    });


    /* Question trigger */
    $(".question").change(function(){
        var value = this.value;
        var form_count = $('#id_questionnaire_set-TOTAL_FORMS').val(); 
        var qid = this.id.split('-')[1];
        var url = '/admin/document/question-details/'+value+'/';
        var data = 'count='+qid+'&form_count='+form_count;

        var onsuccess = function(data, textStatus, xhr){
            $("#id_question-"+qid+"-details").html(data);
        }

        var onerror = function(data, textStatus, xhr){
            alert(error);
        }
       
        $.ajax({
            type: 'GET',
            url: url,
            data: data,
            success: onsuccess,
            error: onerror
        });
    });
});
</script>
<script type="text/javascript" src="/adminmedia/js/admin/RelatedObjectLookups.js"></script>
<script type="text/javascript" src="/admin/jsi18n/"></script>
<script type="text/javascript" src="/adminmedia/js/core.js"></script>
<script type="text/javascript" src="/adminmedia/js/SelectBox.js"></script>
<script type="text/javascript" src="/adminmedia/js/SelectFilter2.js"></script>
{% endblock %}
