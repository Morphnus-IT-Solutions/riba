{% extends request.ws_base|default:'web/base.html' %}
{%block search_menu%}
{%endblock%}
{% block content%}
<div class="h34"> &nbsp;       
</div>
{%load cc_tags%}
{%load web_tags%}

    <div class="cart_left">     
        <form method="post" action="" id="shipping_info_form" name="shipping_info_form">
        <input type="hidden" name="update_addressbook_id" value="{{addressbook_id}}"/>
        {% checkout_tabs request "shipping" %} 
       
        <table class="checkout_table pad10 mart20" id="delivery_table">
            {%if request.session.sync_errors%}
            <tr>
                <td colspan="2" class="bbnone">
                    <div class="error">
                        <ul style="margin:0px;">
                            {% for error in request.session.sync_errors %}
                                <li>{{error.responseMessage}}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </td>
            </tr>
            {%endif%}
            {%if availability_errors%}
            <tr>
                <td colspan="2" class="bbnone">
                    <div class="error">
                        <ul style="margin:0px;">
                            {% for error in availability_errors %}
                                <li>{{error}}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </td>
            </tr>
            {%endif%}
            {% if failed_payment %}
            <tr>
                <td colspan="2" class="bbnone">
                    <div class="error">
                        <h3>Payment Failed</h3>
                        Your payment has been rejected by the payment gateway. Your card has not been charged Please try again, perhaps with a different card
                    </div>
                </td>
            </tr>
            {% endif %}
            {% if shipping_info_form.errors %}
            <tr>
                <td colspan="2" class="bbnone">
                    <div class="error">
                        <ul style="margin:0px;">
                            {% for field in shipping_info_form %}
                            {% for error in field.errors %}
                                <li>{{error}}</li>
                            {% endfor %}
                            {% endfor %}
                        </ul>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% if order_response %}
            <tr>
                <td colspan="2" class="bbnone">
                    <div class="error">
                        <ul style="margin:0px;">
                            <li>{{order_response.responseMessage}}</li>
                        </ul>
                    </div>
                </td>
            </tr>
            {% endif %}
            {% if user_addresses %}
            <tr> 
             <td class="bbnone">
                    {%for address in user_addresses%}
                    <div class="ship_address {% if address.defaddress %} def_ship_address{% endif %}">  
           <div class="fb marb5"><input type="radio" name="del_address" value="{{address.id}}"/> {% if address.defaddress %}Default  {% endif %}Shipping Address</div>
                <div class="dname marb5">{{address.first_name}} {{address.last_name}}</div>
                <div class="daddress" style="overflow:hidden; height:18px;">{{address.address}}</div>
                <div class="dcity">{{address.city.name}} <span class="dpincode">{{address.pincode}}</span></div>
                <div class="dstate">{{address.state.name}}, <span class="dcountry">{{address.country.name}}</span></div>
                <div class="dstate">Email: {{address.email}}</div>
                <div class="dphone">Tel: {{address.phone}}</div>                 
              <div class="ra">
                 <!-- <button type="button" class="linkButton edit_address" id="{{address.id}}">Modify</button> | <button type="button" id="{{address.id}}" class="linkButton delete_address">Remove x</button>-->
                 {% if address.profile.default_address == address.id %}
                     <div> Default Address </div>
                {% endif %}
              </div>
            </div>
                    {%endfor%}
                </td>              
                <td width="55%" class="bbnone">
                <div class="address pad10">
                        <input type="hidden" name="old_address" value="{{delivery_address.id}}"/>
                        <div class="fb">
                            <input type="radio" name="del_address" value="new" checked="checked"/>&nbsp;&nbsp;<span class="fb">Or Enter New Shipping Details :</span><br/>
                        </div>
                 <div id="delivery_address_block" class="left" style="padding-top:5px;">
                      <div class="padb5 mart10">
                            <div class="left">
                                <div class="padb5">First Name {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                                {{shipping_info_form.delivery_first_name}}&nbsp;&nbsp;
                            </div>
                             <div class="left">
                                <div class="padb5">Last Name <span class="fred">*</span></div>
                                {{shipping_info_form.delivery_last_name}}
                            </div>
                            <div class="clear"></div>
                        </div>
                         <div class="padb5">
                        <div class="mart10 padb5">Address {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                        {{shipping_info_form.delivery_address}}</div>
                      <div class="padb5 mart10">
                            <div class="left">
                                <div class="padb5">City {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                                {{shipping_info_form.delivery_city}}&nbsp;&nbsp;
                            </div>
                             <div class="left">
                                <div class="padb5">Pincode <span class="fred">*</span></div>
                                {{shipping_info_form.delivery_pincode}}
                            </div>
                            <div class="clear"></div>
                        </div>
                       <div class="padb5 mart10">
                            <div class="left">
                                <div class="padb5">State</div>
                                {{shipping_info_form.delivery_state}}&nbsp;&nbsp;
                            </div>
                            <div class="left">
                                <div class="padb5">Country {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                                {{shipping_info_form.delivery_country}}
                            </div>
                            <div class="clear"></div>
                        </div>
                          <div class="mart10">
                            <div class="left">
                                <div class="padb5">Phone {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                        {{shipping_info_form.delivery_phone}}&nbsp;&nbsp;
                            </div>
                            <div class="left">
                                <div class="padb5">Email </div>
                                {{shipping_info_form.email}}
                            </div>
                            <div class="clear"></div>
                        </div>                      
                        </div>
                        <div class="clear"></div>
                        <div class="mart10 ra f11"><span class="fred">*</span> Mandatory Fields</div>
                    </div>                 
                       
                </td>
           		
            </tr>
            {% else %}
            <tr>
                <td width="350" class="bbnone">
                    <div class="address pad10" style="padding-top:5px;">
                        <div class="hidden">
                            <input type="hidden" name="old_address" value="{{delivery_address.id}}"/>
                            <input type="radio" name="del_address" checked="checked" value="new"/>&nbsp;&nbsp;<span class="fb">Enter new delivery address</span><br/>
                        </div>
                        <div id="delivery_address_block">
                      <div class="padb5 mart10">
                            <div class="left">
                                <div class="padb5">First Name {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                                {{shipping_info_form.delivery_first_name}}&nbsp;&nbsp;
                            </div>
                             <div class="left">
                                <div class="padb5">Last Name <span class="fred">*</span></div>
                                {{shipping_info_form.delivery_last_name}}
                            </div>
                            <div class="clear"></div>
                        </div>
                         <div class="padb5">
                        <div class="ieh10">Address {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                        {{shipping_info_form.delivery_address}}</div>
                      <div class="padb5">
                            <div class="left">
                                <div>City {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                                {{shipping_info_form.delivery_city}}&nbsp;&nbsp;
                            </div>
                            <div class="left">
                                <div>Pincode <span class="fred">*</span></div>
                                {{shipping_info_form.delivery_pincode}}
                            </div>
                            <div class="clear"></div>
                        </div>
                       <div class="padb5">
                            <div class="left">
                                <div>State</div>
                                {{shipping_info_form.delivery_state}}&nbsp;&nbsp;
                            </div>                         
                            <div class="left">
                                <div>Country {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                                {{shipping_info_form.delivery_country}}
                            </div>
                            <div class="clear"></div>
                        </div>
                        <div>
                            <div class="left">
                                <div>Phone {%if not request|is_cc%}<span class="fred">*</span>{%endif%}</div>
                        {{shipping_info_form.delivery_phone}}&nbsp;&nbsp;
                            </div>
                            <div class="left">
                                <div>Email </div>
                                {{shipping_info_form.email}}
                            </div>
                            <div class="clear"></div>
                        </div>
                       
                    </div>                   
                </td>
                <td class="bbnone">&nbsp;
                </td>
            </tr>   
            <tr><td colspan="2" class="bbnone">
            <div class="fdgray mart5">Note: Fields with (<span class="fred">*</span>) are required</div>
            
            </td></tr>        
            {% endif %}
            <tr>
                <td colspan="2" class="ra bbnone">
                    <span class="f15">Total amount you need to pay: <span class="fb f15"><span class="WebRupee">Rs.</span><!--{{order.formatted_currency}}--> {{order.payable_amount|money}}</span></span>
</td></tr>
 <tr>
                <td colspan="2" class="ra bbnone">
                    {%if request|is_cc%}                       
                        <input type="submit" value="Continue" class="btn btn_proceed" title="Proceed to Book"/>
                    {%else%}
                        <button type="submit" id="proceed" class="btn btn_proceed_to_pay" title="" value=""></button>
                    {%endif%}
                </td>
            </tr>
        </table>
        </form>
    </div>
    <div class="cart_right" id="rightpanel_cart">
        {% include "order/right.html" %}
    </div>
    <div class="clear"></div>
{%endblock%}

{% block script_footer %}
{{block.super}}
<script type="text/javascript">        
$(document).ready(function(){
    {%if request.wstore%}
    $('#proceed_to_pay').click(function(){
        if($.browser.msie || $.browser.webkit){
            $('#shipping_info_form').attr("target","_blank"); 
        }
    });
    {%endif%}
    try {
        document.shipping_info_form.delivery_name.focus();
    } catch(err) {
    }
    $('input[name="del_address"]').click(function() {
            $('input[name="del_address"]').each(function() {
                    if($(this).attr('checked')) {
                        $($($(this).parent()[0]).parent()[0]).addClass('selected_address');
                    } else {
                        $($($(this).parent()[0]).parent()[0]).removeClass('selected_address');
                    }
                });
            });
    $('input[name="del_address"]').each(function() {
                    if($(this).attr('checked')) {
                        $($($(this).parent()[0]).parent()[0]).addClass('selected_address');
                    } else {
                        $($($(this).parent()[0]).parent()[0]).removeClass('selected_address');
                    }
        });

    $('div#delivery_address_block input').focus(function() {
            var radio = $('input[name="del_address"][value="new"]');
            radio.attr('checked','true');
            $('input[name="del_address"]').each(function() {
                    if($(this).attr('checked')) {
                        $($($(this).parent()[0]).parent()[0]).addClass('selected_address');
                    } else {
                        $($($(this).parent()[0]).parent()[0]).removeClass('selected_address');
                    }
                });
            
        });
    $('div#delivery_address_block textarea').focus(function() {
            var radio = $('input[name="del_address"][value="new"]');
            radio.attr('checked','true');
            $('input[name="del_address"]').each(function() {
                    if($(this).attr('checked')) {
                        $($($(this).parent()[0]).parent()[0]).addClass('selected_address');
                    } else {
                        $($($(this).parent()[0]).parent()[0]).removeClass('selected_address');
                    }
                });
            
        });
});
</script>
<script type="text/javascript">
$(document).ready(function(){
    $('.check_tabs').click(function(){
        var next_tab = $(this).attr('id');
        current_url = window.location.href;
        url_splitted = current_url.split("/");
        new_url = url_splitted[0];
        for(var i=1;i<url_splitted.length-1;i++){
            new_url += "/" + url_splitted[i];
        }
        new_url += "/" + next_tab;
        location.href =  new_url;
    });
});
</script>
{% endblock %}
