import os, sys

os.environ['DJANGO_SETTINGS_MODULE'] = 'tinla.settings'

ROOT_FOLDER = os.path.realpath(os.path.dirname(__file__))
ROOT_FOLDER = ROOT_FOLDER[:ROOT_FOLDER.rindex('/')]

if ROOT_FOLDER not in sys.path:
    sys.path.insert(1, ROOT_FOLDER + '/')

# also add the parent folder
PARENT_FOLDER = ROOT_FOLDER[:ROOT_FOLDER.rindex('/')+1]
if PARENT_FOLDER not in sys.path:
    sys.path.insert(1, PARENT_FOLDER)

from users.models import Profile
from integrations.fbapi import users, orders, fbapiutils
from orders.models import *


if __name__ == '__main__':
    #ls = [5028284510,5005260347,5028313536,5028319843,5028373210,5028376517,5028378924,5028382111,5028383372,5028412217,5028414477,5028415554,5028415846,5028415951,5028416181,5028416272,5028416393,5028416486,5028416636,5028417117,5028417165,5028417475,5028417541,5028417930,5028418673,5028418877,5028418955,5028420233,5028420308,5028420502,5028420948,5028423098,5028423288,5028423502,5028423574,5028423703,5028423770,5028423809,5028424429,5028424644,5028424690,5028424719,5028424737,5028424904,5028425096,5028425114,5028425430,5028425507,5028425573,5028425928,5028425992,5028426002,5028426015,5028426080,5028426232,5028426294,5028426337,5028426549,5028426578,5028426657,5028426685,5028426756,5028426850,5028426913,5028427028,5028427641,5028427704,5028427781,5028427811,5028427833,5028427843,5028427858,5028427905,5028427937,5028428026,5028428052,5028428219,5028428250,5028428285,5028428394,5028428430,5028428491,5028428516,5028428594,5028428755,5028428798,5028428874,5028429016,5028429118,5028429121,5028429293,5028429762,5028429975,5028431917,5028433284,5028434159,5028434924,5028435058,5028435531,5028435856,5028435924,5028435961,5028436677,5028436729,5028436792,5028436916,5028436939,5028438146,5028438507,5028438716]
    #ls = [5023451255,5028420314,5005006144,5028425771,5003187248,5028429031,5027507611,5028433156,5024986056,5028413675,5028437849,5005878045,5028446089,5005789454,5028459128,5028472397,5028477903,5028489970,5028472540,5028495032]
    #ls = [5028433156,5028472540,5028425771]
    #ls = [5012914108,5018141827,5026421991,5028126840,5028417792,5028417866,5028420397,5028423066,5028424839,5028428384,5028428697,5028428853,5028428866,5028428946,5028428947,5028428972,5028429009,5028429174,5028429527,5028430033,5028431434,5028431834,5028431918,5028431950,5028432015,5028433417,5028433640,5028434355,5028434420,5028434587,5028434632,5028434857,5028434859,5028435054,5028435301,5028435427,5028435948,5028436025,5028436537,5028436657,5028436804,5028437008,5028437040,5028437152,5028437484,5028437545,5028437650,5028437838,5028438165,5028438343,5028438347,5028438595,5028438745,5028438885,5028438945,5028439095,5028439195,5028439480,5028439792,5028439916,5028440242,5028440620,5028440791,5028441553,5028441870,5028441872,5028442074,5028442091,5028442178,5028442321,5028442357,5028442454,5028442654,5028442915,5028443166,5028443192,5028443323,5028443354,5028443404,5028443469,5028443562,5028443630,5028443722,5028443737,5028443745,5028443785,5028444037,5028444043,5028444130,5028444162,5028444186,5028444354,5028444678,5028445081,5028445399,5028445459,5028445643,5028445662,5028445736,5028445738,5028445783,5028446174,5028446324,5028446499,5028446627,5028446687,5028446766,5028447052,5028447166,5028447752,5028447789,5028447803,5028448133,5028448156,5028448164,5028448204,5028448265,5028448278,5028448393,5028448488,5028448492,5028448924,5028449021,5028449219,5028449291,5028449321,5028449381,5028450220,5028450369,5028450499,5028450721,5028450812,5028451001,5028451013,5028451031,5028451056,5028451068,5028451090,5028451134,5028451286,5028451306,5028451611,5028451725,5028451814,5028451904,5028451994,5028452071,5028452109,5028452146,5028452192,5028452202,5028452225,5028452341,5028452460,5028452478,5028452495,5028452588,5028452612,5028452618,5028452678,5028452800,5028452895,5028453073,5028453231,5028453234,5028453303,5028453378,5028453418,5028453495,5028453535,5028453743,5028453793,5028453935,5028453942,5028454022,5028454079,5028454159,5028454207,5028454239,5028454273,5028454391,5028454491,5028454523,5028454773,5028454844,5028455030,5028455206,5028455263,5028455423,5028455778,5028456123,5028456339,5028456393,5028456499,5028456559,5028456615,5028456667,5028456730,5028456793,5028456851,5028456869,5028456967,5028457008,5028457192,5028457238,5028457279,5028457284,5028457497,5028457640,5028457727,5028458118,5028458482,5028458620,5028458631,5028458664,5028458727,5028458780,5028458808,5028458983,5028459137,5028461414,5028462071,5028462234,5028462328,5028463042,5028468084,5028468712,5028468850,5028469980,5028470237,5028471190,5028471308,5028471375,5028472646,5028476244,5028522938,5028522954,5028522978,5028522995,5028523036,5028523249,5028523259,5028523274,5028523297,5028523635,5028526471,5028475766]

    #ls = [5000010105,5000015304,5000315725,5000321138,5000488044,5000679828,5000773456,5000790781,5000854074,5000921590,5000963774,5001099863,5001124766,5001254260,5001275882,5001289823,5001621677,5001666338,5001713284,5001766733,5001957811,5002724711,5002964956,5003123264,5003128740,5003187248,5003570429,5003579500,5003623209,5003876558,5004221088,5004529859,5004595370,5004816641,5004845165,5004917145,5005006144,5005566843,5005606637,5005781294,5005789454,5005878045,5005968738,5006199757,5012462345,5012563176,5013308418,5013852137,5014341892,5014611493,5014807601,5014841083,5014887049,5016680215,5018740484,5020310136,5020411992,5021408991,5021598587,5021892731,5023049155,5023411223,5023451255,5023523933,5023637246,5023653743,5023724689,5024184185,5024469383,5024750821,5024986056,5025401297,5025504295,5026485226]


    #ls = [5026595429,5026610203,5026682002,5026692515,5026739008,5026851146,5026862600,5027090764,5027136961,5027346535,5027492461,5027507611,5027566643,5027609802,5027610333,5027617265,5027618583,5027684922,5027786123,5027851718,5027852728,5027867977,5027872782,5028056153,5028072264,5028078278,5028134580,5028360270,5028413675,5028415050,5028418698,5028420314,5028422843,5028425771,5028425902,5028426225,5028426886,5028427411,5028428363,5028429031,5028429112,5028430261,5028430994,5028431197,5028431377,5028432332,5028432492,5028432564,5028432619,5028432850,5028432978,5028433032,5028433156,5028433236,5028433556,5028433784,5028434178,5028435210,5028435369,5028435542,5028436106,5028436445,5028436976,5028437001,5028437018,5028437849,5028438888,5028439810,5028440451,5028440460,5028440749,5028440976,5028441700,5028442378,5028442968,5028443385,5028443831,5028443942,5028444359,5028444371,5028445322,5028446089,5028446273,5028446828,5028448187,5028449216,5028449436,5028449638,5028450036,5028450769,5028450919,5028451265,5028451500,5028451589,5028452996,5028453458,5028453463,5028453825,5028453924,5028454162,5028454177,5028455921,5028456020,5028456284,5028456997,5028457473,5028457604,5028458572,5028458990,5028459128,5028459680,5028464974,5028465406,5028472354,5028472397,5028472540,5028477611,5028477903,5028479420,5028489970,5028495032,5028499214,

    #ls = [5028522738,5028522745,5028522762,5028522793,5028522808,5028522809,5028522835,5028522841,5028522846,5028522857,5028522859,5028522869,5028522876,5028522877,5028522887,5028522905,5028522919,5028522920,5028522967,5028522989,5028523010,5028523013,5028523014,5028523019,5028523102,5028523107,5028523113,5028523119,5028523130,5028523132,5028523140,5028523152,5028523154,5028523165,5028523173,5028523181,5028523184,5028523191,5028523193,5028523197,5028523221,5028523227,5028523234,5028523253,5028523288,5028523293,5028523308,5028523311,5028523312,5028523316,5028523317,5028523323,5028523326,5028523332,5028523334,5028523341,5028523387,5028523401,5028523407,5028523424,5028523429,5028523457,5028523466,5028523477,5028523487,5028523493,5028523500,5028523506,5028523524,5028523529,5028523582,5028523590,5028523600,5028523608,5028523617,5028523644,5028523654,5028523718,5028523722,5028523739,5028523763,5028523843,5028523849,5028523893,5028523947,5028523956,5028523970,5028523988,5028524002,5028524008,5028524040,5028524050,5028524063,5028524074,5028524081,5028524102,5028524111,5028524117,5028531256]
    #ls = [5028417866,5028428384,5028428697,5028428866,5028428946,5028429174,5028429527,5028431918,5028434355,5028438347,5028438945,5028439916,5028440242,5028441553,5028441870,5028443404,5028443562,5028443737,5028444130,5028445459,5028445736,5028445738,5028446174,5028446687,5028448133,5028448204,5028449321,5028452192,5028452678,5028453378,5028454022,5028454523,5028454773,5028454844,5028455206,5028456123,5028456499,5028456615,5028462328,5028522738,5028522745,5028522762,5028522793,5028522808,5028522809,5028522835,5028522841,5028522846,5028522857,5028522859,5028522876,5028522877,5028522887,5028522905,5028522919,5028522938,5028522954,5028522967,5028522978,5028522989,5028522995,5028523010,5028523013,5028523014,5028523019,5028523036,5028523102,5028523107,5028523113,5028523119,5028523130,5028523132,5028523140,5028523152,5028523154,5028523165,5028523173,5028523181,5028523184,5028523191,5028523193,5028523221,5028523227,5028523234,5028523249,5028523253,5028523259,5028523274,5028523288,5028523293,5028523297,5028523308,5028523311,5028523312,5028523316,5028523317,5028523323,5028523326,5028523332,5028523334,5028523341,5028523387,5028523407,5028523424,5028523429,5028523457,5028523466,5028523477,5028523487,5028523493,5028523506,5028523524,5028523529,5028523582,5028523590,5028523600,5028523608,5028523617,5028523635,5028523644,5028523654,5028523718,5028523722,5028523739,5028523763,5028523843,5028523849,5028523893,5028523947,5028523956,5028523970,5028523988,5028524002,5028524008,5028524040,5028524050,5028524063,5028524081,5028524102,5028524111,5028524117,5028526471,5028531256]
    ls = [5002144442,5028148683,5028180938,5028194975,5028222591,5028486274,5028486683,5028486935,5028486983,5028487094,5028487146,5028487168,5028487190,5028487218,5028487232,5028487248,5028487262,5028487278,5028487288,5028487297,5028487316,5028487336,5028487412,5028487421,5028487453,5028487461,5028487499,5028487510,5028522738,5028522745,5028522762,5028522793,5028522808,5028522809,5028522835,5028522841,5028522846,5028522857,5028522859,5028522876,5028522877,5028522887,5028522905,5028522919,5028522938,5028522954,5028522967,5028522978,5028522989,5028522995,5028523010,5028523013,5028523014,5028523019,5028523036,5028523102,5028523107,5028523113,5028523119,5028523130,5028523132,5028523140,5028523152,5028523154,5028523165,5028523173,5028523181,5028523184,5028523191,5028523193,5028523221,5028523227,5028523234,5028523249,5028523253,5028523259,5028523274,5028523288,5028523293,5028523297,5028523308,5028523311,5028523312,5028523316,5028523317,5028523323,5028523326,5028523332,5028523334,5028523341,5028523387,5028523407,5028523424,5028523429,5028523457,5028523466,5028523477,5028523487,5028523493,5028523506,5028523524,5028523529,5028523582,5028523590,5028523600,5028523608,5028523617,5028523635,5028523644,5028523654,5028523718,5028523722,5028523739,5028523763,5028523843,5028523849,5028523893,5028523947,5028523956,5028523970,5028523988,5028524002,5028524008,5028524040,5028524050,5028524063,5028524081,5028524102,5028524111,5028524117,5028526471,5028531256,5028542831,5028542885,5028542925,5028542994,5028543047,5028543131,5028543143,5028543185,5028543201,5028543241,5028543297,5028543304,5028543326,5028543337,5028543368,5028543396,5028543422,5028543434,5028543445,5028543467,5028543531,5028543551,5028543570,5028543586,5028543625,5028599483,5028610062,5028610153,5028611480,5028611525,5028611685,5028611696,5028611732,5028611771,5028611793,5028611804,5028611806,5028611822,5028611872,5028611923,5028611936,5028611937]




    cookie_file = fbapiutils.init()

    #orders = Order.objects.filter(reference_order_id__in=ls, state='confirmed')
    
    for l in ls:
        print 'processing....',l
        order = Order.objects.filter(reference_order_id = l, state='confirmed').order_by('-payment_realized_on')
        if order:
            order = order[0]
        else:
            order = Order.objects.filter(reference_order_id = l, state='pending_order').order_by('-timestamp')
            if order:
                order = order[0]
            else:
                order = Order.objects.filter(reference_order_id = l).order_by('-timestamp')
                if order:
                    order = order[0]
                else:
                    print 'not found', l
                    continue
        continue
        try:
            phones =  order.user.get_primary_phones()
            if phones:
                phone = phones[0]
    	    ress = users.get_user_by_mobile(order.user.user.username, 'hemant.fb', cookie_file)
            if ress['responseCode'] != 'UM_FOUND_USER':
                print phones
                print 'not found user',order.user.user.username, order.reference_order_id
                if phones:
    	            ress = users.get_user_by_mobile(phones[0], 'hemant.fb', cookie_file)
                    if ress['responseCode'] != 'UM_FOUND_USER':
                        print 'not found 2ndtry user',order.user.user.username, order.reference_order_id
                        continue
		else:
                    print 'no login',order.user.user.username, order.reference_order_id
                    continue
	    delivery_info = order.get_delivery_info()
	    shipping_address = delivery_info.address
	     
	    billing_info = BillingInfo.objects.filter(user=order.user)
	    if billing_info:
		billing_info = billing_info[len(billing_info) - 1]
		billing_address = billing_info.address
            else:
                continue
	    first_name = ''
	    last_name = ''
	    if order.user.user.first_name:
		first_name = order.user.user.first_name
	    elif billing_info:
		first_name = billing_info.first_name
	    if order.user.user.last_name:
		last_name = order.user.user.last_name
	    elif billing_info:
		last_name = billing_info.last_name
	    delivery_first_name = ''
	    delivery_last_name = ''
	    delivery_first_name = delivery_info.address.name
	    if delivery_info.address.name:
		ls = delivery_info.address.name.split()
		if ls:
		    if len(ls) >1:
			delivery_first_name = ls[0]
			delivery_last_name = ls[1]
	    resp = users.update_user({
		    'first_name': delivery_first_name,
		    'last_name': delivery_last_name,
		    'address': delivery_info.address.address,
		    'city': delivery_info.address.city.name,
		    'state': fbapiutils.STATES_MAP[delivery_info.address.state.name],
		    'country': 'IN',
		    'postal_code': delivery_info.address.pincode,
		    'phone_number': delivery_info.address.phone
		},
		{
		    'first_name': first_name,
		    'last_name': last_name,
		    'address': billing_info.address.address,
		    'city': billing_info.address.city.name,
		    'state': fbapiutils.STATES_MAP[billing_info.address.state.name],
		    'country': 'IN',
		    'postal_code': billing_info.address.pincode,
		    'phone_number': billing_info.phone
		},
		'',
		cookie_file)
	    print resp['responseCode']
        except:
            continue
